name: Zaawansowany CI/CD

on:
  push: {}

jobs:
  test:
    name: Testy jednostkowe
    if: ${{ github.ref != 'refs/heads/main' }}
    runs-on: [self-hosted]
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm test

  lint:
    name: ESLint
    if: ${{ github.ref != 'refs/heads/main' }}
    runs-on: [self-hosted]
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run lint

  build:
    name: Build & Push Docker
    needs: [test, lint]
    runs-on: [self-hosted]
    steps:
      - uses: actions/checkout@v4
      - name: Build + Push
        run: |
          TAG=szyban/ci-cd-kolo:${{ github.sha }}
          docker build -t $TAG .
          docker push $TAG
          echo "$TAG" > image-tag.txt
      - uses: actions/upload-artifact@v4         
        with:
          name: image-tag
          path: image-tag.txt

  staging:
    name: Deploy na STAGING
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: [self-hosted]
    environment: staging
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: image-tag
      - run: |
          TAG=$(cat image-tag.txt)
          echo "Wdrażam na staging obraz: $TAG"

  production:
    name: Deploy na PRODUCTION
    needs: staging
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: [self-hosted]
    environment: production
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: image-tag
      - run: |
          TAG=$(cat image-tag.txt)
          echo "Publikuję na produkcji obraz: $TAG"

  notify:
    name: Raport końcowy
    needs: [build, staging, production]
    if: always()
    runs-on: [self-hosted]
    steps:
      - run: |
          echo "Pipeline zakończony z wynikiem: ${{ job.status }}" > report.txt
          echo "build: ${{ needs.build.result }}"       >> report.txt
          echo "staging: ${{ needs.staging.result }}"   >> report.txt
          echo "production: ${{ needs.production.result }}" >> report.txt
      - uses: actions/upload-artifact@v4         
        with:
          name: ci-report
          path: report.txt
