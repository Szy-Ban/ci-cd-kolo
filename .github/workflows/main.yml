# .github/workflows/main.yml
name: Zaawansowany CI/CD

on:
  push: {}       # kaÅ¼dy push do dowolnej gaÅ‚Ä™zi

jobs:
  # â”€â”€ a) Testy jednostkowe (nie na main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ðŸ§ª Testy jednostkowe
    if: ${{ github.ref != 'refs/heads/main' }}
    runs-on: [self-hosted]
    steps:
      - uses: actions/checkout@v4
      - name: Instalacja zaleÅ¼noÅ›ci
        run: npm ci
      - name: Uruchom testy
        run: npm test

  # â”€â”€ a) Lint (nie na main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ðŸ“ ESLint
    if: ${{ github.ref != 'refs/heads/main' }}
    runs-on: [self-hosted]
    steps:
      - uses: actions/checkout@v4
      - name: Instalacja zaleÅ¼noÅ›ci
        run: npm ci
      - name: Uruchom lint
        run: npm run lint

  # â”€â”€ b) Build & push Docker (nie na main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ðŸ³ Build & Push Docker
    needs: [test, lint]
    if: ${{ github.ref != 'refs/heads/main' }}
    runs-on: [self-hosted]
    steps:
      - uses: actions/checkout@v4
      - name: Budowanie i push
        run: |
          TAG=szyban/ci-cd-kolo:${{ github.sha }}
          docker build -t $TAG .
          docker push $TAG
          echo "$TAG" > image-tag.txt
      - uses: actions/upload-artifact@v3
        with:
          name: image-tag
          path: image-tag.txt

  # â”€â”€ c) Deploy na staging (Tylko main, manualny approve) â”€
  staging:
    name: ðŸš€ Deploy na STAGING
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: [self-hosted]
    environment:
      name: staging
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: image-tag
      - name: Symulacja wdroÅ¼enia na staging
        run: |
          TAG=$(cat image-tag.txt)
          echo "WdraÅ¼am na staging obraz: $TAG"

  # â”€â”€ d) Deploy na production (Tylko main, manualny approve) â”€
  production:
    name: ðŸ›¡ï¸ Deploy na PRODUCTION
    needs: staging
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: [self-hosted]
    environment:
      name: production
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: image-tag
      - name: Symulacja wypchniÄ™cia do produkcji
        run: |
          TAG=$(cat image-tag.txt)
          echo "PublikujÄ™ na produkcji obraz: $TAG"

  # â”€â”€ e) Generowanie raportu (zawsze) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: ðŸ“£ Raport koÅ„cowy
    needs: [test, lint, build, staging, production]
    if: always()
    runs-on: [self-hosted]
    steps:
      - name: Generuj report.txt
        run: |
          echo "Pipeline zakoÅ„czony z wynikiem: ${{ job.status }}" > report.txt
          echo "test: ${{ needs.test.result }}" >> report.txt
          echo "lint: ${{ needs.lint.result }}" >> report.txt
          echo "build: ${{ needs.build.result }}" >> report.txt
          echo "staging: ${{ needs.staging.result }}" >> report.txt
          echo "production: ${{ needs.production.result }}" >> report.txt
      - uses: actions/upload-artifact@v3
        with:
          name: ci-report
          path: report.txt
